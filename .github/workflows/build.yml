name: Build & Test GymTracker

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build on macOS (iOS Simulator)
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      # ── Generate .xcodeproj from project.yml (no Mac needed locally) ──
      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: xcodegen generate --spec project.yml

      # ── Build ──
      - name: Build for iOS Simulator
        run: |
          xcodebuild \
            -project GymTracker.xcodeproj \
            -scheme GymTracker \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            clean build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | xcpretty --color && exit ${PIPESTATUS[0]}

      # ── Boot simulator, install app, screenshot ──
      - name: Screenshot on Simulator
        run: |
          UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 \(" | head -1 | grep -oE '[A-F0-9-]{36}')
          echo "Using simulator: $UDID"
          xcrun simctl boot "$UDID" || true
          sleep 6

          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "GymTracker.app" -path "*/Debug-iphonesimulator/*" | head -1)
          echo "App path: $APP_PATH"
          xcrun simctl install "$UDID" "$APP_PATH"
          xcrun simctl launch  "$UDID" com.gymtracker.app
          sleep 5
          xcrun simctl io "$UDID" screenshot simulator_screenshot.png

      - name: Upload Screenshot
        uses: actions/upload-artifact@v4
        with:
          name: simulator-screenshot
          path: simulator_screenshot.png
