name: Build & Test GymTracker

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build GymTracker (iOS Simulator)
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          sudo xcode-select -s "$(ls -d /Applications/Xcode*.app | grep -iv beta | sort -V | tail -1)"
          xcodebuild -version
          xcrun simctl list runtimes
          xcrun simctl list devices available | grep -i iphone | head -15

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Prepare Sources
        run: |
          mkdir -p Sources/Models Sources/Views
          find . -maxdepth 1 -name '*.swift' -exec cp {} Sources/ \;
          cp Models/*.swift Sources/Models/ 2>/dev/null || true
          cp Views/*.swift  Sources/Views/  2>/dev/null || true
          echo "--- Sources ---"
          find Sources -name '*.swift'

      - name: Generate Xcode Project
        run: xcodegen generate --spec project.yml

      - name: Build for Simulator
        run: |
          set -o pipefail
          xcodebuild \
            -project GymTracker.xcodeproj \
            -scheme GymTracker \
            -destination 'generic/platform=iOS Simulator' \
            clean build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | xcpretty --color

      - name: Take Simulator Screenshot
        continue-on-error: true
        run: |
          UDID=$(xcrun simctl list devices available -j | python3 scripts/find_simulator.py) || true
          if [ -z "$UDID" ]; then
            echo "No iPhone simulator available - skipping screenshot"
            exit 0
          fi
          echo "Booting simulator $UDID"
          xcrun simctl boot "$UDID" 2>/dev/null || true
          sleep 8
          APP=$(find ~/Library/Developer/Xcode/DerivedData -name 'GymTracker.app' -path '*/Debug-iphonesimulator/*' | head -1)
          if [ -z "$APP" ]; then
            echo "Built .app not found - skipping screenshot"
            exit 0
          fi
          xcrun simctl install "$UDID" "$APP"
          xcrun simctl launch  "$UDID" com.gymtracker.app
          sleep 6
          xcrun simctl io "$UDID" screenshot simulator_screenshot.png
          echo "Screenshot captured"

      - name: Upload Screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: simulator-screenshot
          path: simulator_screenshot.png
          if-no-files-found: ignore
          if-no-files-found: ignore
